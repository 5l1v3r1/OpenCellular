from opentest.script import utils
import os

DEFAULT_PRODUCT_INDEX = r'\\ravel\Production\Outils\ConfigFiles\products.ini'
TEST_LOGS_SUB_PATH = r'Test\TestLogs'

# build product dictionary
def build_raw_product_list(path=DEFAULT_PRODUCT_INDEX):
    products = utils.EmptyObject()
    utils.load_ini_in_obj(path, products, use_eval=False)

    return products

def build_mrp_indexed_product_list(*args, **kwargs):
    products = build_raw_product_list(*args, **kwargs)
    product_names = products.get_sections()
    mrp_indexed_product_list = {}
    for name in product_names:
        product_dict = products.get_as_dict(name)
        new_product_dict = {'name': name, 'folder': product_dict['folder']}
        mrp_indexed_product_list[product_dict['mrp']] = new_product_dict

    return mrp_indexed_product_list


def get_test_logs_folder_for_mrp(mrp, sub_path=TEST_LOGS_SUB_PATH, *args, **kwargs):
    product_list = build_mrp_indexed_product_list(*args, **kwargs)
    for key, product in product_list.iteritems():
        if mrp.startswith(key):
            base_folder = product_list[key]['folder']
            break
    else:
        raise Exception('Unable to find product with MRP %s' % mrp)
    return os.path.join(base_folder, sub_path)
