#!/bin/sh

CALIBRATION_FOLDER_DEFAULT="/mnt/app/cal"

usage()
{
    echo "Usage: $0 <BW> <ANT> <FRE> <CAL_FOLDER(optional)>"
    echo ""
    echo "    Extract the Baseband TX attenuation settings from the calibration files"
    echo ""
    echo "    BW            BandWidth"
    echo "    ANT           Antenna selection [1,2]"
    echo "    FREQ          Frequency of BB TX"
    echo "    CAL_FOLDER    Calibration folder(optional), default folder: /tmp"
    exit 1
}

#################  Check and Get Arguments  #####################
if [ "$#" -eq 4 ]; then
    BW=$1
    ANT=$2
    TX_FREQ=$3
    CAL_FOLDER=$4
elif [ "$#" -eq 3 ]; then
    BW=$1
    ANT=$2
    TX_FREQ=$3
    CAL_FOLDER=$CALIBRATION_FOLDER_DEFAULT
else
    echo "$0 - Error : Invalid number of argument $#"
    >&2 usage
fi

#################  Get Band  #####################
TX_BAND=$(bb-gettxband ${TX_FREQ} 2> /dev/null)

##################  Get Calibaration file  ######################
CAL_FNAME="$CAL_FOLDER/bbtxatten_b${TX_BAND}_${BW}_ant${ANT}.cal"

#################  Check Calibaration file  #####################
if [ ! -e ${CAL_FNAME} ]; then
    echo "$0 - Error : The file $CAL_FNAME not found!"
    exit 1
fi

################### Get Attenuation value########################
ATT_TO_SET=$(cal-getbbatt ${BW} ${ANT} ${TX_FREQ} ${CAL_FNAME} 2> /dev/null)
if [ $? -ne 0 ] ; then
    echo "$0 - Error : $ATT_TO_SET"
    exit 1
fi

echo $ATT_TO_SET
