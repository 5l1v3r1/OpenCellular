From 5c5c108a94f17b88b7dd79271a444c5e1425b8db Mon Sep 17 00:00:00 2001
From: Omar Ramadan <omar.ramadan93@gmail.com>
Date: Fri, 7 Sep 2018 01:56:54 -0700
Subject: [PATCH] Update Compose to API 2.3

---
 projects/compose/Makefile                         |  2 +-
 projects/compose/image/Dockerfile                 | 12 ++++++------
 projects/compose/image/Makefile                   |  1 +
 projects/compose/image/load-images-and-compose.sh |  1 +
 4 files changed, 9 insertions(+), 7 deletions(-)
 create mode 100644 projects/compose/image/Makefile

diff --git a/projects/compose/Makefile b/projects/compose/Makefile
index 5387b0b41..74131e21a 100644
--- a/projects/compose/Makefile
+++ b/projects/compose/Makefile
@@ -12,7 +12,7 @@ hash:
 	@echo ${HASH}
 
 tag: $(DEPS)
-	docker build --squash --no-cache -t $(ORG)/$(IMAGE):$(HASH) image/
+	docker build --no-cache -t $(ORG)/$(IMAGE):$(HASH) image/
 
 push: tag
 	DOCKER_CONTENT_TRUST=1 docker pull $(ORG)/$(IMAGE):$(HASH) || \
diff --git a/projects/compose/image/Dockerfile b/projects/compose/image/Dockerfile
index 80dfddbc6..73fc8f1e8 100644
--- a/projects/compose/image/Dockerfile
+++ b/projects/compose/image/Dockerfile
@@ -1,10 +1,10 @@
-FROM docker/compose:1.13.0
+FROM docker/compose:1.22.0
 # because compose requires all sorts of dynamic libs, including glibc, it is much easier to
 #   add docker client to compose than the reverse
 
-ENV DOCKER_BUCKET get.docker.com
-ENV DOCKER_VERSION 17.05.0-ce
-ENV DOCKER_SHA256 340e0b5a009ba70e1b644136b94d13824db0aeb52e09071410f35a95d94316d9
+ENV DOCKER_BUCKET download.docker.com
+ENV DOCKER_VERSION 18.06.0-ce
+ENV DOCKER_SHA256 1c2fa625496465c68b856db0ba850eaad7a16221ca153661ca718de4a2217705
 
 # we need docker compose and docker load
 # also need curl to test availability of docker API
@@ -12,10 +12,10 @@ RUN apk add --update curl
 
 # we only need the client
 RUN set -x \
-	&& curl -fSL "https://${DOCKER_BUCKET}/builds/Linux/x86_64/docker-${DOCKER_VERSION}.tgz" -o docker.tgz \
+	&& curl -fSL "https://${DOCKER_BUCKET}/linux/static/stable/x86_64/docker-${DOCKER_VERSION}.tgz" -o docker.tgz \
 	&& echo "${DOCKER_SHA256} *docker.tgz" | sha256sum -c - \
 	&& tar -xzvf docker.tgz \
-	&& mv docker/docker /usr/bin/ \
+	&& mv docker/docker /usr/local/bin/ \
 	&& rm -rf docker docker.tgz \
 	&& docker -v
 
diff --git a/projects/compose/image/Makefile b/projects/compose/image/Makefile
new file mode 100644
index 000000000..28ba9d4e4
--- /dev/null
+++ b/projects/compose/image/Makefile
@@ -0,0 +1 @@
+include ../../../make/Makefile
diff --git a/projects/compose/image/load-images-and-compose.sh b/projects/compose/image/load-images-and-compose.sh
index 574a8bac3..f4cf0e367 100755
--- a/projects/compose/image/load-images-and-compose.sh
+++ b/projects/compose/image/load-images-and-compose.sh
@@ -17,3 +17,4 @@ fi
 
 
 docker-compose -f /compose/docker-compose.yml up -d
+tail -f /dev/null
-- 
2.14.1

